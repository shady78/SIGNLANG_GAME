<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لعبة لغة الإشارة - نسخة متقدمة</title>
  <style>
    :root {
      --bg: #fff8f0;
      --primary: #f29f05;
      --primary-2: #f2c572;
      --accent: #ff7f11;
      --text: #333;
      --muted: #8a8a8a;
      --ok: #21a179;
      --danger: #c0392b;
      --card: #ffffff;
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    #app { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { width: 100%; max-width: 420px; padding: 16px; }
    .card { background: var(--card); border-radius: 20px; box-shadow: var(--shadow); padding: 18px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-badge { width: 40px; height: 40px; border-radius: 12px; background: var(--primary); display: grid; place-items: center; color: #fff; font-weight: 800; }
    .h1 { font-size: 20px; margin: 0; }
    .h2 { font-size: 18px; margin: 10px 0 8px; }
    .p { color: var(--muted); font-size: 14px; margin: 0; }

    .btn {
      width: 100%; padding: 12px 16px; background: var(--primary); color: white; border: none;
      border-radius: 14px; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(242, 159, 5, 0.3); }
    .btn.secondary { background: #eee; color: #333; }
    .btn.row { width: auto; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); }

    .tile {
      background: #fff; border: 2px solid #ffe4bd; border-radius: 16px; padding: 16px;
      text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative;
    }
    .tile:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .tile.locked { opacity: 0.5; cursor: not-allowed; }
    .tile.locked::after {
      content: '🔒'; position: absolute; top: 10px; right: 10px;
      font-size: 20px; opacity: 0.7;
    }

    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      background: #fff4df; color: #7a4f00; font-size: 12px; font-weight: 600;
    }

    .input { width: 100%; padding: 12px; border: 1.5px solid #f3d7aa; border-radius: 12px; background: white; font-family: inherit; }
    .timer { font-weight: 700; color: #7a4f00; }

    .choice {
      background: #fffaf2; border: 1.5px solid #ffd9a0; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: right;
    }
    .choice:hover { background: #fff7e6; border-color: var(--primary); transform: translateX(-2px); }
    .choice.correct { border-color: #21a179; background: #e7fbf5; animation: correctPulse 0.5s ease; }
    .choice.wrong { border-color: #c0392b; background: #ffe9e7; animation: shake 0.5s ease; }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .hint {
      background: #fff7df; border: 1.5px dashed #f2c572; padding: 10px;
      border-radius: 12px; color: #6a5200; animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .footer { display: flex; gap: 8px; justify-content: space-between; margin-top: 14px; }

    .navbar {
      position: sticky; bottom: 0; background: #fffdf8; border-top: 1px solid #ffe3bd;
      display: flex; gap: 8px; padding: 10px; border-radius: 16px 16px 0 0;
    }
    .navbar a {
      flex: 1; text-align: center; text-decoration: none; color: #333;
      padding: 8px 4px; border-radius: 10px; transition: all 0.2s ease;
    }
    .navbar a:hover { background: #fff8e8; }
    .navbar a.active { background: #fff1d0; font-weight: 600; }

    .avatar {
      width: 100%; aspect-ratio: 16/9; background: linear-gradient(120deg, #fff2cf, #ffe6b9);
      border: 2px dashed #f2c572; border-radius: 16px; display: grid; place-items: center;
      color: #7a4f00; position: relative; overflow: hidden;
    }

    .character-img {
      position: absolute; width: 200px; height: 200px; object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .character-sign {
      position: absolute; top: 20px; right: 20px; background: white;
      border-radius: 50%; padding: 12px; font-size: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .character-message {
      position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; font-weight: 600;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .small { font-size: 12px; color: var(--muted); }

    .chat {
      display: flex; flex-direction: column; gap: 8px; max-height: 50vh;
      overflow: auto; padding: 8px; background: #fffaf2; border-radius: 12px;
      border: 1px solid #ffe1b5;
    }

    .msg {
      padding: 8px 10px; background: #fff; border-radius: 12px;
      align-self: flex-start; max-width: 80%; box-shadow: var(--shadow);
      animation: messageSlide 0.3s ease;
    }
    .msg.me { align-self: flex-end; background: #fff1d0; }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .progress-bar {
      width: 100%; height: 8px; background: #f0f0f0; border-radius: 10px;
      overflow: hidden; margin: 10px 0;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 10px; transition: width 0.3s ease;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff9e6, #ffe9c5);
      border: 2px solid #ffd89b; border-radius: 12px; padding: 12px;
      text-align: center; transition: all 0.3s ease;
    }
    .stat-card:hover { transform: scale(1.05); }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .achievement {
      display: inline-block; background: #fff; border: 2px solid #ffd700;
      border-radius: 12px; padding: 8px 12px; margin: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .leaderboard-item {
      background: #fff; border-radius: 12px; padding: 12px;
      margin-bottom: 8px; display: flex; justify-content: space-between;
      align-items: center; transition: all 0.2s ease;
    }
    .leaderboard-item:hover { transform: translateX(-4px); box-shadow: var(--shadow); }
    .rank { font-size: 20px; font-weight: 800; color: var(--primary); }

    .simulation-option {
      background: #fff; border: 2px solid #e0e0e0; border-radius: 16px;
      padding: 20px; margin: 10px 0; cursor: pointer;
      transition: all 0.3s ease; text-align: center;
    }
    .simulation-option:hover { border-color: var(--primary); background: #fffaf2; }
    .simulation-option.selected { border-color: var(--ok); background: #e7fbf5; }

    .countdown {
      font-size: 48px; font-weight: 800; color: var(--primary);
      animation: countPulse 1s ease infinite;
    }

    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: none; align-items: center;
      justify-content: center; z-index: 1000;
    }
    .modal.show { display: flex; animation: fadeIn 0.3s ease; }
    .modal-content {
      background: white; border-radius: 20px; padding: 24px;
      max-width: 400px; width: 90%; animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .streak-badge {
      display: inline-block; background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white; padding: 6px 12px; border-radius: 20px;
      font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(255,107,107,0.3);
    }

    .multiplayer-room {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 2px solid #64b5f6; border-radius: 16px; padding: 16px; margin: 10px 0;
    }

    .player-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary); color: white;
      display: grid; place-items: center; font-weight: 700;
    }

    @media (max-width: 480px) {
      .container { padding: 12px; }
      .card { padding: 14px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <!-- Modal Container -->
  <div id="modal" class="modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <script>
    /** Router **/
    const routes = {};
    function route(path, render) { routes[path] = render; }
    function go(path) { location.hash = path; }
    function startRouter() {
      window.addEventListener("hashchange", render);
      if (!location.hash) location.hash = "/";
      render();
    }
    function el(html) {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }
    function $(sel, root = document) { return root.querySelector(sel); }
    function $$(sel, root = document) { return root.querySelectorAll(sel); }

    /** Memory Storage **/
    const MemoryDB = {
      data: {},
      get(key, fallback) { return this.data[key] !== undefined ? this.data[key] : fallback; },
      set(key, val) { this.data[key] = val; },
    };

    /** Questions Data - موسع **/
    const questionsData = {
      stage1: [
        { id: "q1", text: "ما الإشارة الصحيحة التي تمثل حرف (أ)؟", signImage: "✊", choices: ["👋", "✊", "🤚"], correctIndex: 1, hint: "قبضة اليد قد تمثل الحروف الساكنة.", difficulty: "easy" },
        { id: "q2", text: "أي حركة تعبّر عن كلمة (السلام)؟", signImage: "👋", choices: ["تحريك اليدين للأمام", "وضع اليد على القلب", "رفع السبابة"], correctIndex: 0, hint: "فكر في حركة الترحيب والهدوء.", difficulty: "easy" },
        { id: "q3", text: "الإشارة المناسبة لكلمة (شكراً) هي؟", signImage: "🙏", choices: ["ملامسة الذقن ثم إبعاد اليد", "تحريك الرأس يمين ويسار", "وضع اليدين خلف الظهر"], correctIndex: 0, hint: "غالبًا تبدأ من الفم/الذقن باتجاه الخارج.", difficulty: "medium" },
        { id: "q4", text: "كيف نشير إلى كلمة (أنا)؟", signImage: "👈", choices: ["الإشارة إلى النفس", "رفع اليد عالياً", "التصفيق"], correctIndex: 0, hint: "الإشارة الذاتية تكون نحو الصدر.", difficulty: "easy" },
        { id: "q5", text: "ما هي إشارة (نعم)؟", signImage: "👍", choices: ["هز الرأس للأسفل", "رفع الإبهام", "تحريك اليد يميناً"], correctIndex: 1, hint: "إشارة الموافقة العالمية.", difficulty: "easy" },
        { id: "q6", text: "كيف نشير إلى (لا)؟", signImage: "👎", choices: ["خفض الإبهام", "هز الرأس", "رفع اليدين"], correctIndex: 0, hint: "عكس إشارة الموافقة.", difficulty: "easy" },
        { id: "q7", text: "إشارة (الطعام)؟", signImage: "🍽️", choices: ["إيماءة الأكل نحو الفم", "فرك البطن", "التصفيق"], correctIndex: 0, hint: "حركة تحاكي وضع الطعام في الفم.", difficulty: "medium" },
      ],
      stage2: [
        { id: "q8", text: "ما إشارة (الماء)؟", signImage: "💧", choices: ["رسم حرف W بالأصابع", "حركة الشرب", "النقر على الجبهة"], correctIndex: 1, hint: "تحاكي حركة الشرب من كوب.", difficulty: "medium" },
        { id: "q9", text: "كيف نشير إلى (العائلة)؟", signImage: "👨‍👩‍👧‍👦", choices: ["دائرة باليدين", "إشارة للقلب", "التصفيق"], correctIndex: 0, hint: "تجمع الناس معاً.", difficulty: "hard" },
        { id: "q10", text: "إشارة (الحب)؟", signImage: "❤️", choices: ["وضع اليد على القلب", "تشابك الأصابع", "رفع اليدين"], correctIndex: 0, hint: "مكان المشاعر.", difficulty: "easy" },
      ],
      stage3: [
        { id: "q11", text: "كيف نشير إلى (المدرسة)؟", signImage: "🏫", choices: ["فتح كتاب وهمي", "الإشارة للأمام", "التصفيق مرتين"], correctIndex: 0, hint: "مكان التعلم والكتب.", difficulty: "hard" },
        { id: "q12", text: "إشارة (السعادة)؟", signImage: "😊", choices: ["الابتسام مع حركة لأعلى", "القفز", "التصفيق"], correctIndex: 0, hint: "تعبير عن الفرح.", difficulty: "medium" },
      ]
    };

    /** Achievements System **/
    const achievements = [
      { id: "first_win", name: "أول فوز", icon: "🏆", condition: (user) => user.gamesPlayed >= 1 },
      { id: "level_5", name: "مستوى 5", icon: "⭐", condition: (user) => user.level >= 5 },
      { id: "perfect_score", name: "نتيجة مثالية", icon: "💯", condition: (user) => user.perfectGames >= 1 },
      { id: "streak_3", name: "سلسلة 3", icon: "🔥", condition: (user) => user.streak >= 3 },
      { id: "social_butterfly", name: "اجتماعي", icon: "💬", condition: (user) => user.messagesSent >= 10 },
    ];

    /** Initialize User Profile **/
    function initProfile() {
      const u = MemoryDB.get("user", null);
      if (!u) {
        MemoryDB.set("user", {
          uid: "u1", name: "لاعب", level: 1, xp: 0, gamesPlayed: 0,
          perfectGames: 0, streak: 0, bestScore: 0, totalScore: 0,
          unlockedStages: ["stage1"], achievements: [], messagesSent: 0,
          lastPlayDate: null, dailyStreak: 0
        });
      }
    }

    /** Gain XP with Level Up Animation **/
    function gainXP(points, isPerfect = false) {
      const u = MemoryDB.get("user", {});
      const oldLevel = u.level || 1;
      u.xp = (u.xp || 0) + points;
      u.totalScore = (u.totalScore || 0) + points;
      u.gamesPlayed = (u.gamesPlayed || 0) + 1;
      
      if (points > (u.bestScore || 0)) u.bestScore = points;
      if (isPerfect) u.perfectGames = (u.perfectGames || 0) + 1;
      
      // Level up calculation
      const newLevel = Math.floor(u.xp / 50) + 1;
      u.level = newLevel;
      
      // Unlock stages based on level
      if (newLevel >= 3 && !u.unlockedStages.includes("stage2")) {
        u.unlockedStages.push("stage2");
        showModal("مرحلة جديدة!", "🎉 لقد فتحت المرحلة الثانية!");
      }
      if (newLevel >= 5 && !u.unlockedStages.includes("stage3")) {
        u.unlockedStages.push("stage3");
        showModal("مرحلة متقدمة!", "🌟 لقد فتحت المرحلة الثالثة!");
      }
      
      // Check achievements
      checkAchievements(u);
      
      MemoryDB.set("user", u);
      
      // Show level up modal
      if (newLevel > oldLevel) {
        showModal("ترقية!", `🎊 لقد وصلت للمستوى ${newLevel}!`);
      }
      
      return newLevel > oldLevel;
    }

    function checkAchievements(user) {
      achievements.forEach(ach => {
        if (!user.achievements.includes(ach.id) && ach.condition(user)) {
          user.achievements.push(ach.id);
          showModal("إنجاز جديد!", `${ach.icon} ${ach.name}`);
        }
      });
    }

    function showModal(title, message) {
      const modal = $("#modal");
      const content = $("#modal-content");
      content.innerHTML = `
        <h2 class="h2" style="text-align:center">${title}</h2>
        <p style="text-align:center;font-size:32px;margin:20px 0">${message}</p>
        <button class="btn" onclick="closeModal()">رائع!</button>
      `;
      modal.classList.add("show");
      setTimeout(() => closeModal(), 3000);
    }

    window.closeModal = function() {
      $("#modal").classList.remove("show");
    };

    async function loadQuestions(stageId = "stage1") {
      return questionsData[stageId] || [];
    }

    /** Character Avatar **/
    function createCharacterAvatar(signEmoji = "👋", message = "مرحباً! أنا هنا لمساعدتك 👋") {
      return `
        <div class="avatar">
          <img src="https://i.postimg.cc/3RQM0b65/20251021-0019-image.png" alt="شخصية" class="character-img" />
          ${signEmoji ? `<div class="character-sign">${signEmoji}</div>` : ""}
          <div class="character-message">${message}</div>
        </div>
      `;
    }

    /** Layout **/
    function layout(children, activeTab = "home") {
      const u = MemoryDB.get("user", {});
      return el(`<div class="container">
        <div class="card">
          <div class="header">
            <div class="brand">
              <div class="brand-badge">إ</div>
              <div>
                <h1 class="h1">لعبة لغة الإشارة</h1>
                <p class="p">مستوى ${u.level || 1} • ${u.xp || 0} XP</p>
              </div>
            </div>
            <button class="btn row" onclick="go('/profile')">👤</button>
          </div>
          <div style="height:12px"></div>
          ${children}
        </div>
        <div style="height:12px"></div>
        <nav class="navbar">
          <a href="#/home" class="${activeTab === "home" ? "active" : ""}">🏠<br><span style="font-size:10px">الرئيسية</span></a>
          <a href="#/quiz" class="${activeTab === "quiz" ? "active" : ""}">📝<br><span style="font-size:10px">الأسئلة</span></a>
          <a href="#/simulation" class="${activeTab === "simulation" ? "active" : ""}">🎮<br><span style="font-size:10px">المحاكاة</span></a>
          <a href="#/multiplayer" class="${activeTab === "multiplayer" ? "active" : ""}">👥<br><span style="font-size:10px">جماعي</span></a>
          <a href="#/community" class="${activeTab === "community" ? "active" : ""}">💬<br><span style="font-size:10px">مجتمع</span></a>
        </nav>
      </div>`);
    }

    /** Welcome Screen **/
    routes["/"] = () => {
      const view = el(`<div class="container">
        <div class="card" style="text-align:center">
          <div class="brand" style="justify-content:center;margin-bottom:12px">
            <div class="brand-badge" style="width:64px;height:64px;font-size:22px;">إ</div>
            <div>
              <h1 class="h1">أهلاً بك</h1>
              <p class="p">ابدأ التعلم باللعب ✨</p>
            </div>
          </div>
          ${createCharacterAvatar("👋", "مرحباً! دعنا نبدأ رحلة التعلم 🌟")}
          <div style="height:12px"></div>
          <button class="btn" onclick="go('/home')">🚀 ابدأ الآن</button>
        </div>
      </div>`);
      $("#app").replaceChildren(view);
    };

    /** Home Page - Enhanced **/
    routes["/home"] = () => {
      const u = MemoryDB.get("user", {});
      const xpProgress = ((u.xp % 50) / 50) * 100;
      const nextLevel = u.level + 1;
      const xpToNext = 50 - (u.xp % 50);
      
      const content = `
      <h2 class="h2">مرحباً ${u.name}! 👋</h2>
      
      <div style="background:#fff4df;padding:12px;border-radius:12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-size:12px">المستوى ${u.level}</span>
          <span style="font-size:12px">${xpToNext} XP للمستوى ${nextLevel}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${xpProgress}%"></div>
        </div>
      </div>

      <div class="grid" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-value">${u.level || 1}</div>
          <div class="stat-label">المستوى</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.xp || 0}</div>
          <div class="stat-label">نقاط الخبرة</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.gamesPlayed || 0}</div>
          <div class="stat-label">عدد الألعاب</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.bestScore || 0}</div>
          <div class="stat-label">أفضل نتيجة</div>
        </div>
      </div>

      <h3 style="font-size:16px;margin-bottom:8px">🎮 الأقسام</h3>
      <div class="grid">
        <div class="tile" onclick="go('/stages')">
          <div class="badge">جديد</div>
          <h3 style="font-size:16px;margin:8px 0">🎯 المراحل</h3>
          <p class="p">اختر مرحلتك وابدأ التحدي</p>
        </div>
        <div class="tile" onclick="go('/simulation')">
          <div class="badge">تفاعلي</div>
          <h3 style="font-size:16px;margin:8px 0">🎭 المحاكاة</h3>
          <p class="p">تدرب مع الشخصية الذكية</p>
        </div>
        <div class="tile" onclick="go('/multiplayer')">
          <div class="badge">تنافسي</div>
          <h3 style="font-size:16px;margin:8px 0">⚔️ جماعي</h3>
          <p class="p">تحدى لاعبين آخرين</p>
        </div>
        <div class="tile" onclick="go('/community')">
          <div class="badge">مجتمع</div>
          <h3 style="font-size:16px;margin:8px 0">💬 الدردشة</h3>
          <p class="p">تواصل مع المتعلمين</p>
        </div>
      </div>

      ${u.achievements.length > 0 ? `
        <h3 style="font-size:16px;margin:16px 0 8px">🏆 إنجازاتك</h3>
        <div style="background:#fff;border-radius:12px;padding:12px;text-align:center">
          ${u.achievements.map(id => {
            const ach = achievements.find(a => a.id === id);
            return `<span class="achievement">${ach.icon} ${ach.name}</span>`;
          }).join('')}
        </div>
      ` : ''}
      `;
      $("#app").replaceChildren(layout(content, "home"));
    };

    /** Stages Selection - NEW **/
    routes["/stages"] = () => {
      const u = MemoryDB.get("user", {});
      const stages = [
        { id: "stage1", name: "المرحلة الأولى", icon: "🌱", level: 1, description: "أساسيات لغة الإشارة" },
        { id: "stage2", name: "المرحلة الثانية", icon: "🌿", level: 3, description: "مستوى متوسط" },
        { id: "stage3", name: "المرحلة الثالثة", icon: "🌳", level: 5, description: "مستوى متقدم" }
      ];

      const content = `
        <h2 class="h2">🎯 اختر المرحلة</h2>
        ${stages.map(stage => {
          const isUnlocked = u.unlockedStages.includes(stage.id);
          const isAvailable = u.level >= stage.level;
          return `
            <div class="tile ${!isUnlocked || !isAvailable ? 'locked' : ''}" 
                 onclick="${isUnlocked && isAvailable ? `startQuiz('${stage.id}')` : ''}"
                 style="grid-column:1/-1;text-align:right;padding:16px;margin-bottom:8px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <h3 style="font-size:18px;margin:0">${stage.icon} ${stage.name}</h3>
                  <p class="p" style="margin:4px 0 0">${stage.description}</p>
                  ${!isUnlocked || !isAvailable ? `<span class="badge">المستوى ${stage.level} مطلوب</span>` : ''}
                </div>
                <div style="font-size:32px">${isUnlocked && isAvailable ? '▶️' : '🔒'}</div>
              </div>
            </div>
          `;
        }).join('')}
        <button class="btn secondary" onclick="go('/home')" style="margin-top:10px">🏠 العودة</button>
      `;
      $("#app").replaceChildren(layout(content, "quiz"));
    };

    window.startQuiz = function(stageId) {
      location.hash = `/quiz?stage=${stageId}`;
    };

    /** Enhanced Quiz **/
    routes["/quiz"] = async () => {
      const urlParams = new URLSearchParams(location.hash.split('?')[1]);
      const stageId = urlParams.get('stage') || 'stage1';
      const qs = await loadQuestions(stageId);
      
      let index = 0;
      let score = 0;
      let correctAnswers = 0;
      let locked = false;
      let timePerQ = 20;
      let timeLeft = timePerQ;
      let timerId = null;
      let combo = 0;
      let maxCombo = 0;

      function renderQ() {
        const q = qs[index];
        if (!q) {
          clearInterval(timerId);
          const isPerfect = correctAnswers === qs.length;
          const leveledUp = gainXP(score, isPerfect);
          const u = MemoryDB.get("user", {});
          
          const done = el(`<div class="container">
            <div class="card" style="text-align:center">
              ${createCharacterAvatar(isPerfect ? "🎉" : "👏", isPerfect ? "مثالي! أنت رائع!" : "أحسنت! استمر بالتحسن")}
              <div style="height:12px"></div>
              <h2 class="h2">🎊 النتيجة النهائية</h2>
              <div class="countdown" style="font-size:64px;margin:20px 0">${score}</div>
              <p class="p">نقطة</p>
              
              <div style="background:#fff4df;padding:16px;border-radius:12px;margin:16px 0;text-align:right">
                <div style="margin-bottom:8px">✅ إجابات صحيحة: <b>${correctAnswers}/${qs.length}</b></div>
                <div style="margin-bottom:8px">🔥 أقصى سلسلة: <b>${maxCombo}</b></div>
                <div style="margin-bottom:8px">⭐ المستوى: <b>${u.level}</b></div>
                <div>💎 الخبرة الكلية: <b>${u.xp} XP</b></div>
              </div>

              ${isPerfect ? `<div class="achievement" style="margin:10px 0">💯 نتيجة مثالية!</div>` : ''}
              
              <div class="row" style="gap:8px">
                <button class="btn" onclick="go('/stages')" style="flex:1">🔄 إعادة</button>
                <button class="btn secondary" onclick="go('/home')" style="flex:1">🏠 الرئيسية</button>
              </div>
            </div>
          </div>`);
          $("#app").replaceChildren(done);
          return;
        }

        const choices = q.choices.map((c, i) => `<button class="choice" data-i="${i}">${c}</button>`).join("");
        const difficultyColor = q.difficulty === 'easy' ? '#21a179' : q.difficulty === 'medium' ? '#f29f05' : '#c0392b';
        
        const view = layout(`
          <div class="row" style="justify-content:space-between;margin-bottom:10px">
            <div>
              <div class="badge">سؤال ${index + 1}/${qs.length}</div>
              ${combo > 1 ? `<span class="streak-badge">🔥 ${combo}</span>` : ''}
            </div>
            <div class="timer" style="font-size:18px">⏱ ${timeLeft}s</div>
          </div>
          
          <div style="background:#fff4df;padding:8px 12px;border-radius:8px;margin-bottom:10px;text-align:center">
            <span style="color:${difficultyColor};font-weight:600">⚡ ${q.difficulty === 'easy' ? 'سهل' : q.difficulty === 'medium' ? 'متوسط' : 'صعب'}</span>
            <span style="margin:0 10px">•</span>
            <span style="font-weight:600">النقاط: ${score}</span>
          </div>

          ${createCharacterAvatar(q.signImage || "🤔", "راقب الإشارة جيداً!")}
          <h2 class="h2" style="margin:16px 0">${q.text}</h2>
          <div class="grid">${choices}</div>
          <div class="row" style="margin-top:10px;gap:8px">
            ${q.hint ? `<button id="hintBtn" class="btn secondary" style="flex:1">💡 تلميح</button>` : ''}
            <button id="skipBtn" class="btn secondary" style="flex:1">⏭ تخطي</button>
          </div>
          ${q.hint ? `<div id="hintBox" class="hint" style="display:none;margin-top:8px">💡 ${q.hint}</div>` : ''}
        `, "quiz");

        $("#app").replaceChildren(view);

        $("#hintBtn")?.addEventListener("click", () => {
          const box = $("#hintBox");
          if (box) box.style.display = box.style.display === "none" ? "block" : "none";
        });

        $("#skipBtn").addEventListener("click", () => {
          combo = 0;
          nextQ();
        });

        // attach handlers to all choice buttons (fix: use $$ not $)
        $$(".choice").forEach(btn => {
          btn.addEventListener("click", (e) => {
            if (locked) return;
            locked = true;
            const i = Number(e.currentTarget.getAttribute("data-i"));
            const correct = i === q.correctIndex;
            
            if (correct) {
              const points = q.difficulty === 'easy' ? 10 : q.difficulty === 'medium' ? 15 : 20;
              const timeBonus = Math.floor(timeLeft / 2);
              const comboBonus = combo * 2;
              const totalPoints = points + timeBonus + comboBonus;
              
              score += totalPoints;
              correctAnswers++;
              combo++;
              if (combo > maxCombo) maxCombo = combo;
              
              e.currentTarget.classList.add("correct");
              
              if (totalPoints > points) {
                const bonus = el(`<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--ok);color:white;padding:10px 20px;border-radius:12px;font-weight:700;animation:slideUp 0.5s ease">+${totalPoints} 🎉</div>`);
                e.currentTarget.style.position = 'relative';
                e.currentTarget.appendChild(bonus);
              }
            } else {
              combo = 0;
              e.currentTarget.classList.add("wrong");
            }
            
            setTimeout(() => nextQ(), 1200);
          });
        });

        clearInterval(timerId);
        timeLeft = timePerQ;
        timerId = setInterval(() => {
          timeLeft--;
          const t = $(".timer");
          if (t) {
            t.textContent = `⏱ ${timeLeft}s`;
            if (timeLeft <= 5) t.style.color = '#c0392b';
          }
          if (timeLeft <= 0) {
            clearInterval(timerId);
            combo = 0;
            nextQ();
          }
        }, 1000);
      }

      function nextQ() {
        index++;
        locked = false;
        renderQ();
      }
      renderQ();
    };

    /** Enhanced Simulation **/
    routes["/simulation"] = () => {
      const u = MemoryDB.get("user", {});
      let selectedSign = null;
      let currentQuestion = null;
      
      const simulationQuestions = [
        { sign: "👋", options: ["السلام", "وداعاً", "مرحباً"], correct: "مرحباً" },
        { sign: "👍", options: ["نعم", "لا", "ربما"], correct: "نعم" },
        { sign: "❤️", options: ["حب", "صداقة", "عائلة"], correct: "حب" },
        { sign: "🙏", options: ["شكراً", "من فضلك", "آسف"], correct: "شكراً" },
      ];
      
      currentQuestion = simulationQuestions[Math.floor(Math.random() * simulationQuestions.length)];
      
      const content = `
        <h2 class="h2">🎭 المحاكاة التفاعلية</h2>
        <p class="p">شاهد الإشارة واختر المعنى الصحيح</p>
        
        ${createCharacterAvatar(currentQuestion.sign, "ما معنى هذه الإشارة؟")}
        
        <h3 style="text-align:center;margin:20px 0">ما معنى هذه الإشارة؟</h3>
        
        <div id="options">
          ${currentQuestion.options.map(opt => `
            <div class="simulation-option" data-option="${opt}">
              <h3 style="margin:0">${opt}</h3>
            </div>
          `).join('')}
        </div>
        
        <button id="checkBtn" class="btn" disabled style="margin-top:16px">✓ تحقق من الإجابة</button>
        <button class="btn secondary" onclick="location.reload()" style="margin-top:8px">🔄 سؤال جديد</button>
      `;
      
      const view = layout(content, "simulation");
      $("#app").replaceChildren(view);
      
      // simulation options: use $$ to get NodeList
      $$(".simulation-option").forEach(opt => {
        opt.addEventListener("click", (e) => {
          $$(".simulation-option").forEach(o => o.classList.remove("selected"));
          e.currentTarget.classList.add("selected");
          selectedSign = e.currentTarget.getAttribute("data-option");
          $("#checkBtn").disabled = false;
        });
      });
      
      $("#checkBtn").addEventListener("click", () => {
        if (selectedSign === currentQuestion.correct) {
          showModal("صحيح! 🎉", "إجابة ممتازة! +10 XP");
          gainXP(10);
          setTimeout(() => location.reload(), 2000);
        } else {
          showModal("خطأ 😅", "حاول مرة أخرى!");
        }
      });
    };

    /** Enhanced Multiplayer **/
    routes["/multiplayer"] = () => {
      const u = MemoryDB.get("user", {});
      const rooms = MemoryDB.get("rooms", [
        { id: "room1", name: "غرفة المبتدئين", players: 3, maxPlayers: 4, difficulty: "سهل" },
        { id: "room2", name: "غرفة المحترفين", players: 2, maxPlayers: 4, difficulty: "صعب" },
        { id: "room3", name: "تحدي السرعة", players: 1, maxPlayers: 2, difficulty: "متوسط" },
      ]);
      
      const leaderboard = MemoryDB.get("leaderboard", [
        { name: "أحمد", score: 850, level: 8 },
        { name: u.name, score: u.totalScore || 0, level: u.level },
        { name: "فاطمة", score: 720, level: 7 },
        { name: "محمد", score: 650, level: 6 },
        { name: "سارة", score: 580, level: 5 },
      ]).sort((a, b) => b.score - a.score);
      
      const content = `
        <h2 class="h2">⚔️ اللعب الجماعي</h2>
        
        <h3 style="font-size:16px;margin:16px 0 8px">🏆 لوحة المتصدرين</h3>
        <div style="background:#fff;border-radius:12px;padding:12px;margin-bottom:16px;max-height:200px;overflow:auto">
          ${leaderboard.slice(0, 5).map((player, i) => `
            <div class="leaderboard-item ${player.name === u.name ? 'style="background:#fff4df"' : ''}">
              <div style="display:flex;align-items:center;gap:12px">
                <span class="rank">#${i + 1}</span>
                <div class="player-avatar">${player.name[0]}</div>
                <div>
                  <div style="font-weight:600">${player.name}</div>
                  <div class="small">المستوى ${player.level}</div>
                </div>
              </div>
              <div style="font-weight:700;color:var(--primary)">${player.score}</div>
            </div>
          `).join('')}
        </div>
        
        <h3 style="font-size:16px;margin:16px 0 8px">🚪 الغرف المتاحة</h3>
        ${rooms.map(room => `
          <div class="multiplayer-room" onclick="joinRoom('${room.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="margin:0;font-size:16px">${room.name}</h3>
              <span class="badge">${room.difficulty}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="small">👥 ${room.players}/${room.maxPlayers} لاعبين</span>
              <span style="color:var(--primary);font-weight:600">انضم ←</span>
            </div>
          </div>
        `).join('')}
        
        <button class="btn" onclick="createRoom()" style="margin-top:12px">➕ إنشاء غرفة جديدة</button>
      `;
      
      $("#app").replaceChildren(layout(content, "multiplayer"));
    };

    window.joinRoom = function(roomId) {
      showModal("قريباً!", "🎮 سيتم إضافة اللعب الجماعي قريباً!");
    };

    window.createRoom = function() {
      showModal("قريباً!", "🎮 سيتم إضافة إنشاء الغرف قريباً!");
    };

    /** Enhanced Community **/
    routes["/community"] = () => {
      const user = MemoryDB.get("user", {});
      const key = "chat:global";
      const messages = MemoryDB.get(key, [
        { uid: "bot", name: "🤖 المساعد", text: "مرحباً بكم في مجتمع لغة الإشارة! 👋", at: Date.now() - 60000 },
        { uid: "u2", name: "أحمد", text: "السلام عليكم! كيف أبدأ التعلم؟", at: Date.now() - 50000 },
        { uid: "bot", name: "🤖 المساعد", text: "ابدأ من المرحلة الأولى وتدرب يومياً! 📚", at: Date.now() - 40000 },
      ]);

      const view = layout(`
        <h2 class="h2">💬 المجتمع</h2>
        <p class="p">تواصل مع متعلمين آخرين وشارك تجربتك</p>
        
        <div class="chat" id="chat"></div>
        
        <div class="row" style="margin-top:12px">
          <input id="msg" class="input" placeholder="اكتب رسالة..." style="flex:1" />
          <button id="sendBtn" class="btn row">📤</button>
        </div>
        
        <div style="text-align:center;margin-top:12px">
          <span class="small">💬 ${user.messagesSent || 0} رسالة أرسلتها</span>
        </div>
      `, "community");
      
      $("#app").replaceChildren(view);

      function renderMsgs() {
        const box = $("#chat");
        box.innerHTML = "";
        messages.forEach(m => {
          const time = new Date(m.at);
          const timeStr = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
          const item = el(`<div class="msg ${m.uid === user.uid ? "me" : ""}">
            <div class="small">${m.name} • ${timeStr}</div>
            <div style="margin-top:4px">${m.text}</div>
          </div>`);
          box.appendChild(item);
        });
        box.scrollTop = box.scrollHeight;
      }
      renderMsgs();

      function sendMsg() {
        const input = $("#msg");
        const text = input.value.trim();
        if (!text) return;
        
        messages.push({
          uid: user.uid,
          name: user.name || "لاعب",
          text,
          at: Date.now(),
        });
        
        user.messagesSent = (user.messagesSent || 0) + 1;
        MemoryDB.set("user", user);
        MemoryDB.set(key, messages);
        input.value = "";
        renderMsgs();

        // Auto responses
        const responses = [
          "رائع! استمر في التعلم 🌟",
          "نصيحة ممتازة! شكراً للمشاركة 👍",
          "هذا ملهم جداً! 💪",
          "معلومة مفيدة! 📚",
        ];
        
        setTimeout(() => {
          messages.push({
            uid: "bot",
            name: "🤖 المساعد",
            text: responses[Math.floor(Math.random() * responses.length)],
            at: Date.now(),
          });
          MemoryDB.set(key, messages);
          renderMsgs();
        }, 2000);
      }

      $("#sendBtn").addEventListener("click", sendMsg);
      $("#msg").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMsg();
      });
    };

    /** Enhanced Profile **/
    routes["/profile"] = () => {
      const u = MemoryDB.get("user", {});
      const nextLevelXP = u.level * 50;
      const progress = ((u.xp % 50) / 50) * 100;
      
      const unlockedAchievements = u.achievements.map(id => 
        achievements.find(a => a.id === id)
      );
      
      const content = `
        <h2 class="h2">👤 الملف الشخصي</h2>
        
        <div style="text-align:center;margin:20px 0">
          <div class="player-avatar" style="width:80px;height:80px;font-size:32px;margin:0 auto 12px">
            ${u.name[0]}
          </div>
          <h2 style="margin:8px 0">${u.name}</h2>
          <div class="badge">المستوى ${u.level}</div>
        </div>
        
        <div style="background:#fff4df;padding:12px;border-radius:12px;margin:16px 0">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <span class="small">التقدم للمستوى ${u.level + 1}</span>
            <span class="small">${u.xp} / ${nextLevelXP} XP</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%"></div>
          </div>
        </div>
        
        <div class="grid">
          <div class="stat-card">
            <div class="stat-value">${u.totalScore || 0}</div>
            <div class="stat-label">إجمالي النقاط</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.gamesPlayed || 0}</div>
            <div class="stat-label">عدد الألعاب</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.bestScore || 0}</div>
            <div class="stat-label">أفضل نتيجة</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.perfectGames || 0}</div>
            <div class="stat-label">نتائج مثالية</div>
          </div>
        </div>
        
        <h3 style="font-size:16px;margin:20px 0 8px">🏆 الإنجازات (${unlockedAchievements.length}/${achievements.length})</h3>
        <div style="background:#fff;border-radius:12px;padding:16px;text-align:center">
          ${unlockedAchievements.length > 0 ? 
            unlockedAchievements.map(ach => `<span class="achievement">${ach.icon} ${ach.name}</span>`).join('') :
            '<p class="p">لم تحصل على أي إنجاز بعد. ابدأ اللعب!</p>'
          }
        </div>
        
        <h3 style="font-size:16px;margin:20px 0 8px">📊 الإحصائيات</h3>
        <div style="background:#fff;border-radius:12px;padding:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px">
            <span>المراحل المفتوحة</span>
            <b>${u.unlockedStages.length}/3</b>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px">
            <span>الرسائل المرسلة</span>
            <b>${u.messagesSent || 0}</b>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>معدل النجاح</span>
            <b>${u.gamesPlayed > 0 ? Math.round((u.perfectGames / u.gamesPlayed) * 100) : 0}%</b>
          </div>
        </div>
        
        <button class="btn secondary" onclick="if(confirm('هل تريد حقاً إعادة ضبط كل البيانات؟')) { location.reload(); }" style="margin-top:16px">
          🔄 إعادة ضبط البيانات
        </button>
      `;
      
      $("#app").replaceChildren(layout(content, "profile"));
    };

    function render() {
      const path = location.hash.split('?')[0].replace("#", "") || "/";
      if (routes[path]) routes[path]();
      else go("/");
    }

    // Initialize
    initProfile();
    startRouter();
  </script>
</body>
</html>