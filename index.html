<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„Ø¹Ø¨Ø© Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© - Ù†Ø³Ø®Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</title>
  <style>
    :root {
      --bg: #fff8f0;
      --primary: #f29f05;
      --primary-2: #f2c572;
      --accent: #ff7f11;
      --text: #333;
      --muted: #8a8a8a;
      --ok: #21a179;
      --danger: #c0392b;
      --card: #ffffff;
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    #app { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { width: 100%; max-width: 420px; padding: 16px; }
    .card { background: var(--card); border-radius: 20px; box-shadow: var(--shadow); padding: 18px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-badge { width: 40px; height: 40px; border-radius: 12px; background: var(--primary); display: grid; place-items: center; color: #fff; font-weight: 800; }
    .h1 { font-size: 20px; margin: 0; }
    .h2 { font-size: 18px; margin: 10px 0 8px; }
    .p { color: var(--muted); font-size: 14px; margin: 0; }

    .btn {
      width: 100%; padding: 12px 16px; background: var(--primary); color: white; border: none;
      border-radius: 14px; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(242, 159, 5, 0.3); }
    .btn.secondary { background: #eee; color: #333; }
    .btn.row { width: auto; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); }

    .tile {
      background: #fff; border: 2px solid #ffe4bd; border-radius: 16px; padding: 16px;
      text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative;
    }
    .tile:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .tile.locked { opacity: 0.5; cursor: not-allowed; }
    .tile.locked::after {
      content: 'ğŸ”’'; position: absolute; top: 10px; right: 10px;
      font-size: 20px; opacity: 0.7;
    }

    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      background: #fff4df; color: #7a4f00; font-size: 12px; font-weight: 600;
    }

    .input { width: 100%; padding: 12px; border: 1.5px solid #f3d7aa; border-radius: 12px; background: white; font-family: inherit; }
    .timer { font-weight: 700; color: #7a4f00; }

    .choice {
      background: #fffaf2; border: 1.5px solid #ffd9a0; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: right;
    }
    .choice:hover { background: #fff7e6; border-color: var(--primary); transform: translateX(-2px); }
    .choice.correct { border-color: #21a179; background: #e7fbf5; animation: correctPulse 0.5s ease; }
    .choice.wrong { border-color: #c0392b; background: #ffe9e7; animation: shake 0.5s ease; }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .hint {
      background: #fff7df; border: 1.5px dashed #f2c572; padding: 10px;
      border-radius: 12px; color: #6a5200; animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .footer { display: flex; gap: 8px; justify-content: space-between; margin-top: 14px; }

    .navbar {
      position: sticky; bottom: 0; background: #fffdf8; border-top: 1px solid #ffe3bd;
      display: flex; gap: 8px; padding: 10px; border-radius: 16px 16px 0 0;
    }
    .navbar a {
      flex: 1; text-align: center; text-decoration: none; color: #333;
      padding: 8px 4px; border-radius: 10px; transition: all 0.2s ease;
    }
    .navbar a:hover { background: #fff8e8; }
    .navbar a.active { background: #fff1d0; font-weight: 600; }

    .avatar {
      width: 100%; aspect-ratio: 16/9; background: linear-gradient(120deg, #fff2cf, #ffe6b9);
      border: 2px dashed #f2c572; border-radius: 16px; display: grid; place-items: center;
      color: #7a4f00; position: relative; overflow: hidden;
    }

    .character-img {
      position: absolute; width: 200px; height: 200px; object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .character-sign {
      position: absolute; top: 20px; right: 20px; background: white;
      border-radius: 50%; padding: 12px; font-size: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .character-message {
      position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; font-weight: 600;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .small { font-size: 12px; color: var(--muted); }

    .chat {
      display: flex; flex-direction: column; gap: 8px; max-height: 50vh;
      overflow: auto; padding: 8px; background: #fffaf2; border-radius: 12px;
      border: 1px solid #ffe1b5;
    }

    .msg {
      padding: 8px 10px; background: #fff; border-radius: 12px;
      align-self: flex-start; max-width: 80%; box-shadow: var(--shadow);
      animation: messageSlide 0.3s ease;
    }
    .msg.me { align-self: flex-end; background: #fff1d0; }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .progress-bar {
      width: 100%; height: 8px; background: #f0f0f0; border-radius: 10px;
      overflow: hidden; margin: 10px 0;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 10px; transition: width 0.3s ease;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff9e6, #ffe9c5);
      border: 2px solid #ffd89b; border-radius: 12px; padding: 12px;
      text-align: center; transition: all 0.3s ease;
    }
    .stat-card:hover { transform: scale(1.05); }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .achievement {
      display: inline-block; background: #fff; border: 2px solid #ffd700;
      border-radius: 12px; padding: 8px 12px; margin: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .leaderboard-item {
      background: #fff; border-radius: 12px; padding: 12px;
      margin-bottom: 8px; display: flex; justify-content: space-between;
      align-items: center; transition: all 0.2s ease;
    }
    .leaderboard-item:hover { transform: translateX(-4px); box-shadow: var(--shadow); }
    .rank { font-size: 20px; font-weight: 800; color: var(--primary); }

    .simulation-option {
      background: #fff; border: 2px solid #e0e0e0; border-radius: 16px;
      padding: 20px; margin: 10px 0; cursor: pointer;
      transition: all 0.3s ease; text-align: center;
    }
    .simulation-option:hover { border-color: var(--primary); background: #fffaf2; }
    .simulation-option.selected { border-color: var(--ok); background: #e7fbf5; }

    .countdown {
      font-size: 48px; font-weight: 800; color: var(--primary);
      animation: countPulse 1s ease infinite;
    }

    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: none; align-items: center;
      justify-content: center; z-index: 1000;
    }
    .modal.show { display: flex; animation: fadeIn 0.3s ease; }
    .modal-content {
      background: white; border-radius: 20px; padding: 24px;
      max-width: 400px; width: 90%; animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .streak-badge {
      display: inline-block; background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white; padding: 6px 12px; border-radius: 20px;
      font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(255,107,107,0.3);
    }

    .multiplayer-room {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 2px solid #64b5f6; border-radius: 16px; padding: 16px; margin: 10px 0;
    }

    .player-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary); color: white;
      display: grid; place-items: center; font-weight: 700;
    }

    @media (max-width: 480px) {
      .container { padding: 12px; }
      .card { padding: 14px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <!-- Modal Container -->
  <div id="modal" class="modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <script>
    /** Router **/
    const routes = {};
    function route(path, render) { routes[path] = render; }
    function go(path) { location.hash = path; }
    function startRouter() {
      window.addEventListener("hashchange", render);
      if (!location.hash) location.hash = "/";
      render();
    }
    function el(html) {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }
    function $(sel, root = document) { return root.querySelector(sel); }
    function $$(sel, root = document) { return root.querySelectorAll(sel); }

    /** Memory Storage **/
    const MemoryDB = {
      data: {},
      get(key, fallback) { return this.data[key] !== undefined ? this.data[key] : fallback; },
      set(key, val) { this.data[key] = val; },
    };

    /** Questions Data - Ù…ÙˆØ³Ø¹ **/
    const questionsData = {
      stage1: [
        { id: "q1", text: "Ù…Ø§ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ø­Ø±Ù (Ø£)ØŸ", signImage: "âœŠ", choices: ["ğŸ‘‹", "âœŠ", "ğŸ¤š"], correctIndex: 1, hint: "Ù‚Ø¨Ø¶Ø© Ø§Ù„ÙŠØ¯ Ù‚Ø¯ ØªÙ…Ø«Ù„ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø³Ø§ÙƒÙ†Ø©.", difficulty: "easy" },
        { id: "q2", text: "Ø£ÙŠ Ø­Ø±ÙƒØ© ØªØ¹Ø¨Ù‘Ø± Ø¹Ù† ÙƒÙ„Ù…Ø© (Ø§Ù„Ø³Ù„Ø§Ù…)ØŸ", signImage: "ğŸ‘‹", choices: ["ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙŠØ¯ÙŠÙ† Ù„Ù„Ø£Ù…Ø§Ù…", "ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù„Ø¨", "Ø±ÙØ¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø©"], correctIndex: 0, hint: "ÙÙƒØ± ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„Ù‡Ø¯ÙˆØ¡.", difficulty: "easy" },
        { id: "q3", text: "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙƒÙ„Ù…Ø© (Ø´ÙƒØ±Ø§Ù‹) Ù‡ÙŠØŸ", signImage: "ğŸ™", choices: ["Ù…Ù„Ø§Ù…Ø³Ø© Ø§Ù„Ø°Ù‚Ù† Ø«Ù… Ø¥Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙŠØ¯", "ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø±Ø£Ø³ ÙŠÙ…ÙŠÙ† ÙˆÙŠØ³Ø§Ø±", "ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙŠÙ† Ø®Ù„Ù Ø§Ù„Ø¸Ù‡Ø±"], correctIndex: 0, hint: "ØºØ§Ù„Ø¨Ù‹Ø§ ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙÙ…/Ø§Ù„Ø°Ù‚Ù† Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø®Ø§Ø±Ø¬.", difficulty: "medium" },
        { id: "q4", text: "ÙƒÙŠÙ Ù†Ø´ÙŠØ± Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø© (Ø£Ù†Ø§)ØŸ", signImage: "ğŸ‘ˆ", choices: ["Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†ÙØ³", "Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ Ø¹Ø§Ù„ÙŠØ§Ù‹", "Ø§Ù„ØªØµÙÙŠÙ‚"], correctIndex: 0, hint: "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© ØªÙƒÙˆÙ† Ù†Ø­Ùˆ Ø§Ù„ØµØ¯Ø±.", difficulty: "easy" },
        { id: "q5", text: "Ù…Ø§ Ù‡ÙŠ Ø¥Ø´Ø§Ø±Ø© (Ù†Ø¹Ù…)ØŸ", signImage: "ğŸ‘", choices: ["Ù‡Ø² Ø§Ù„Ø±Ø£Ø³ Ù„Ù„Ø£Ø³ÙÙ„", "Ø±ÙØ¹ Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù…", "ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙŠØ¯ ÙŠÙ…ÙŠÙ†Ø§Ù‹"], correctIndex: 1, hint: "Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.", difficulty: "easy" },
        { id: "q6", text: "ÙƒÙŠÙ Ù†Ø´ÙŠØ± Ø¥Ù„Ù‰ (Ù„Ø§)ØŸ", signImage: "ğŸ‘", choices: ["Ø®ÙØ¶ Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù…", "Ù‡Ø² Ø§Ù„Ø±Ø£Ø³", "Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙŠÙ†"], correctIndex: 0, hint: "Ø¹ÙƒØ³ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.", difficulty: "easy" },
        { id: "q7", text: "Ø¥Ø´Ø§Ø±Ø© (Ø§Ù„Ø·Ø¹Ø§Ù…)ØŸ", signImage: "ğŸ½ï¸", choices: ["Ø¥ÙŠÙ…Ø§Ø¡Ø© Ø§Ù„Ø£ÙƒÙ„ Ù†Ø­Ùˆ Ø§Ù„ÙÙ…", "ÙØ±Ùƒ Ø§Ù„Ø¨Ø·Ù†", "Ø§Ù„ØªØµÙÙŠÙ‚"], correctIndex: 0, hint: "Ø­Ø±ÙƒØ© ØªØ­Ø§ÙƒÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¹Ø§Ù… ÙÙŠ Ø§Ù„ÙÙ….", difficulty: "medium" },
      ],
      stage2: [
        { id: "q8", text: "Ù…Ø§ Ø¥Ø´Ø§Ø±Ø© (Ø§Ù„Ù…Ø§Ø¡)ØŸ", signImage: "ğŸ’§", choices: ["Ø±Ø³Ù… Ø­Ø±Ù W Ø¨Ø§Ù„Ø£ØµØ§Ø¨Ø¹", "Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø±Ø¨", "Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¨Ù‡Ø©"], correctIndex: 1, hint: "ØªØ­Ø§ÙƒÙŠ Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø±Ø¨ Ù…Ù† ÙƒÙˆØ¨.", difficulty: "medium" },
        { id: "q9", text: "ÙƒÙŠÙ Ù†Ø´ÙŠØ± Ø¥Ù„Ù‰ (Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©)ØŸ", signImage: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", choices: ["Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø§Ù„ÙŠØ¯ÙŠÙ†", "Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù‚Ù„Ø¨", "Ø§Ù„ØªØµÙÙŠÙ‚"], correctIndex: 0, hint: "ØªØ¬Ù…Ø¹ Ø§Ù„Ù†Ø§Ø³ Ù…Ø¹Ø§Ù‹.", difficulty: "hard" },
        { id: "q10", text: "Ø¥Ø´Ø§Ø±Ø© (Ø§Ù„Ø­Ø¨)ØŸ", signImage: "â¤ï¸", choices: ["ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù„Ø¨", "ØªØ´Ø§Ø¨Ùƒ Ø§Ù„Ø£ØµØ§Ø¨Ø¹", "Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙŠÙ†"], correctIndex: 0, hint: "Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø§Ø¹Ø±.", difficulty: "easy" },
      ],
      stage3: [
        { id: "q11", text: "ÙƒÙŠÙ Ù†Ø´ÙŠØ± Ø¥Ù„Ù‰ (Ø§Ù„Ù…Ø¯Ø±Ø³Ø©)ØŸ", signImage: "ğŸ«", choices: ["ÙØªØ­ ÙƒØªØ§Ø¨ ÙˆÙ‡Ù…ÙŠ", "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø£Ù…Ø§Ù…", "Ø§Ù„ØªØµÙÙŠÙ‚ Ù…Ø±ØªÙŠÙ†"], correctIndex: 0, hint: "Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„ÙƒØªØ¨.", difficulty: "hard" },
        { id: "q12", text: "Ø¥Ø´Ø§Ø±Ø© (Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©)ØŸ", signImage: "ğŸ˜Š", choices: ["Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù… Ù…Ø¹ Ø­Ø±ÙƒØ© Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„Ù‚ÙØ²", "Ø§Ù„ØªØµÙÙŠÙ‚"], correctIndex: 0, hint: "ØªØ¹Ø¨ÙŠØ± Ø¹Ù† Ø§Ù„ÙØ±Ø­.", difficulty: "medium" },
      ]
    };

    /** Achievements System **/
    const achievements = [
      { id: "first_win", name: "Ø£ÙˆÙ„ ÙÙˆØ²", icon: "ğŸ†", condition: (user) => user.gamesPlayed >= 1 },
      { id: "level_5", name: "Ù…Ø³ØªÙˆÙ‰ 5", icon: "â­", condition: (user) => user.level >= 5 },
      { id: "perfect_score", name: "Ù†ØªÙŠØ¬Ø© Ù…Ø«Ø§Ù„ÙŠØ©", icon: "ğŸ’¯", condition: (user) => user.perfectGames >= 1 },
      { id: "streak_3", name: "Ø³Ù„Ø³Ù„Ø© 3", icon: "ğŸ”¥", condition: (user) => user.streak >= 3 },
      { id: "social_butterfly", name: "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", icon: "ğŸ’¬", condition: (user) => user.messagesSent >= 10 },
    ];

    /** Initialize User Profile **/
    function initProfile() {
      const u = MemoryDB.get("user", null);
      if (!u) {
        MemoryDB.set("user", {
          uid: "u1", name: "Ù„Ø§Ø¹Ø¨", level: 1, xp: 0, gamesPlayed: 0,
          perfectGames: 0, streak: 0, bestScore: 0, totalScore: 0,
          unlockedStages: ["stage1"], achievements: [], messagesSent: 0,
          lastPlayDate: null, dailyStreak: 0
        });
      }
    }

    /** Gain XP with Level Up Animation **/
    function gainXP(points, isPerfect = false) {
      const u = MemoryDB.get("user", {});
      const oldLevel = u.level || 1;
      u.xp = (u.xp || 0) + points;
      u.totalScore = (u.totalScore || 0) + points;
      u.gamesPlayed = (u.gamesPlayed || 0) + 1;
      
      if (points > (u.bestScore || 0)) u.bestScore = points;
      if (isPerfect) u.perfectGames = (u.perfectGames || 0) + 1;
      
      // Level up calculation
      const newLevel = Math.floor(u.xp / 50) + 1;
      u.level = newLevel;
      
      // Unlock stages based on level
      if (newLevel >= 3 && !u.unlockedStages.includes("stage2")) {
        u.unlockedStages.push("stage2");
        showModal("Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©!", "ğŸ‰ Ù„Ù‚Ø¯ ÙØªØ­Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©!");
      }
      if (newLevel >= 5 && !u.unlockedStages.includes("stage3")) {
        u.unlockedStages.push("stage3");
        showModal("Ù…Ø±Ø­Ù„Ø© Ù…ØªÙ‚Ø¯Ù…Ø©!", "ğŸŒŸ Ù„Ù‚Ø¯ ÙØªØ­Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©!");
      }
      
      // Check achievements
      checkAchievements(u);
      
      MemoryDB.set("user", u);
      
      // Show level up modal
      if (newLevel > oldLevel) {
        showModal("ØªØ±Ù‚ÙŠØ©!", `ğŸŠ Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${newLevel}!`);
      }
      
      return newLevel > oldLevel;
    }

    function checkAchievements(user) {
      achievements.forEach(ach => {
        if (!user.achievements.includes(ach.id) && ach.condition(user)) {
          user.achievements.push(ach.id);
          showModal("Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯!", `${ach.icon} ${ach.name}`);
        }
      });
    }

    function showModal(title, message) {
      const modal = $("#modal");
      const content = $("#modal-content");
      content.innerHTML = `
        <h2 class="h2" style="text-align:center">${title}</h2>
        <p style="text-align:center;font-size:32px;margin:20px 0">${message}</p>
        <button class="btn" onclick="closeModal()">Ø±Ø§Ø¦Ø¹!</button>
      `;
      modal.classList.add("show");
      setTimeout(() => closeModal(), 3000);
    }

    window.closeModal = function() {
      $("#modal").classList.remove("show");
    };

    async function loadQuestions(stageId = "stage1") {
      return questionsData[stageId] || [];
    }

    /** Character Avatar **/
    function createCharacterAvatar(signEmoji = "ğŸ‘‹", message = "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ğŸ‘‹") {
      return `
        <div class="avatar">
          <img src="https://i.postimg.cc/3RQM0b65/20251021-0019-image.png" alt="Ø´Ø®ØµÙŠØ©" class="character-img" />
          ${signEmoji ? `<div class="character-sign">${signEmoji}</div>` : ""}
          <div class="character-message">${message}</div>
        </div>
      `;
    }

    /** Layout **/
    function layout(children, activeTab = "home") {
      const u = MemoryDB.get("user", {});
      return el(`<div class="container">
        <div class="card">
          <div class="header">
            <div class="brand">
              <div class="brand-badge">Ø¥</div>
              <div>
                <h1 class="h1">Ù„Ø¹Ø¨Ø© Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</h1>
                <p class="p">Ù…Ø³ØªÙˆÙ‰ ${u.level || 1} â€¢ ${u.xp || 0} XP</p>
              </div>
            </div>
            <button class="btn row" onclick="go('/profile')">ğŸ‘¤</button>
          </div>
          <div style="height:12px"></div>
          ${children}
        </div>
        <div style="height:12px"></div>
        <nav class="navbar">
          <a href="#/home" class="${activeTab === "home" ? "active" : ""}">ğŸ <br><span style="font-size:10px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
          <a href="#/quiz" class="${activeTab === "quiz" ? "active" : ""}">ğŸ“<br><span style="font-size:10px">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span></a>
          <a href="#/simulation" class="${activeTab === "simulation" ? "active" : ""}">ğŸ®<br><span style="font-size:10px">Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</span></a>
          <a href="#/multiplayer" class="${activeTab === "multiplayer" ? "active" : ""}">ğŸ‘¥<br><span style="font-size:10px">Ø¬Ù…Ø§Ø¹ÙŠ</span></a>
          <a href="#/community" class="${activeTab === "community" ? "active" : ""}">ğŸ’¬<br><span style="font-size:10px">Ù…Ø¬ØªÙ…Ø¹</span></a>
        </nav>
      </div>`);
    }

    /** Welcome Screen **/
    routes["/"] = () => {
      const view = el(`<div class="container">
        <div class="card" style="text-align:center">
          <div class="brand" style="justify-content:center;margin-bottom:12px">
            <div class="brand-badge" style="width:64px;height:64px;font-size:22px;">Ø¥</div>
            <div>
              <h1 class="h1">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h1>
              <p class="p">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ù„Ø¹Ø¨ âœ¨</p>
            </div>
          </div>
          ${createCharacterAvatar("ğŸ‘‹", "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø¯Ø¹Ù†Ø§ Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… ğŸŒŸ")}
          <div style="height:12px"></div>
          <button class="btn" onclick="go('/home')">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        </div>
      </div>`);
      $("#app").replaceChildren(view);
    };

    /** Home Page - Enhanced **/
    routes["/home"] = () => {
      const u = MemoryDB.get("user", {});
      const xpProgress = ((u.xp % 50) / 50) * 100;
      const nextLevel = u.level + 1;
      const xpToNext = 50 - (u.xp % 50);
      
      const content = `
      <h2 class="h2">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${u.name}! ğŸ‘‹</h2>
      
      <div style="background:#fff4df;padding:12px;border-radius:12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-size:12px">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${u.level}</span>
          <span style="font-size:12px">${xpToNext} XP Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${nextLevel}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${xpProgress}%"></div>
        </div>
      </div>

      <div class="grid" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-value">${u.level || 1}</div>
          <div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.xp || 0}</div>
          <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.gamesPlayed || 0}</div>
          <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${u.bestScore || 0}</div>
          <div class="stat-label">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</div>
        </div>
      </div>

      <h3 style="font-size:16px;margin-bottom:8px">ğŸ® Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
      <div class="grid">
        <div class="tile" onclick="go('/stages')">
          <div class="badge">Ø¬Ø¯ÙŠØ¯</div>
          <h3 style="font-size:16px;margin:8px 0">ğŸ¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h3>
          <p class="p">Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„ØªÙƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ</p>
        </div>
        <div class="tile" onclick="go('/simulation')">
          <div class="badge">ØªÙØ§Ø¹Ù„ÙŠ</div>
          <h3 style="font-size:16px;margin:8px 0">ğŸ­ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</h3>
          <p class="p">ØªØ¯Ø±Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</p>
        </div>
        <div class="tile" onclick="go('/multiplayer')">
          <div class="badge">ØªÙ†Ø§ÙØ³ÙŠ</div>
          <h3 style="font-size:16px;margin:8px 0">âš”ï¸ Ø¬Ù…Ø§Ø¹ÙŠ</h3>
          <p class="p">ØªØ­Ø¯Ù‰ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†</p>
        </div>
        <div class="tile" onclick="go('/community')">
          <div class="badge">Ù…Ø¬ØªÙ…Ø¹</div>
          <h3 style="font-size:16px;margin:8px 0">ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
          <p class="p">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†</p>
        </div>
      </div>

      ${u.achievements.length > 0 ? `
        <h3 style="font-size:16px;margin:16px 0 8px">ğŸ† Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ</h3>
        <div style="background:#fff;border-radius:12px;padding:12px;text-align:center">
          ${u.achievements.map(id => {
            const ach = achievements.find(a => a.id === id);
            return `<span class="achievement">${ach.icon} ${ach.name}</span>`;
          }).join('')}
        </div>
      ` : ''}
      `;
      $("#app").replaceChildren(layout(content, "home"));
    };

    /** Stages Selection - NEW **/
    routes["/stages"] = () => {
      const u = MemoryDB.get("user", {});
      const stages = [
        { id: "stage1", name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", icon: "ğŸŒ±", level: 1, description: "Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©" },
        { id: "stage2", name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", icon: "ğŸŒ¿", level: 3, description: "Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙˆØ³Ø·" },
        { id: "stage3", name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", icon: "ğŸŒ³", level: 5, description: "Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙ‚Ø¯Ù…" }
      ];

      const content = `
        <h2 class="h2">ğŸ¯ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h2>
        ${stages.map(stage => {
          const isUnlocked = u.unlockedStages.includes(stage.id);
          const isAvailable = u.level >= stage.level;
          return `
            <div class="tile ${!isUnlocked || !isAvailable ? 'locked' : ''}" 
                 onclick="${isUnlocked && isAvailable ? `startQuiz('${stage.id}')` : ''}"
                 style="grid-column:1/-1;text-align:right;padding:16px;margin-bottom:8px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <h3 style="font-size:18px;margin:0">${stage.icon} ${stage.name}</h3>
                  <p class="p" style="margin:4px 0 0">${stage.description}</p>
                  ${!isUnlocked || !isAvailable ? `<span class="badge">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${stage.level} Ù…Ø·Ù„ÙˆØ¨</span>` : ''}
                </div>
                <div style="font-size:32px">${isUnlocked && isAvailable ? 'â–¶ï¸' : 'ğŸ”’'}</div>
              </div>
            </div>
          `;
        }).join('')}
        <button class="btn secondary" onclick="go('/home')" style="margin-top:10px">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
      `;
      $("#app").replaceChildren(layout(content, "quiz"));
    };

    window.startQuiz = function(stageId) {
      location.hash = `/quiz?stage=${stageId}`;
    };

    /** Enhanced Quiz **/
    routes["/quiz"] = async () => {
      const urlParams = new URLSearchParams(location.hash.split('?')[1]);
      const stageId = urlParams.get('stage') || 'stage1';
      const qs = await loadQuestions(stageId);
      
      let index = 0;
      let score = 0;
      let correctAnswers = 0;
      let locked = false;
      let timePerQ = 20;
      let timeLeft = timePerQ;
      let timerId = null;
      let combo = 0;
      let maxCombo = 0;

      function renderQ() {
        const q = qs[index];
        if (!q) {
          clearInterval(timerId);
          const isPerfect = correctAnswers === qs.length;
          const leveledUp = gainXP(score, isPerfect);
          const u = MemoryDB.get("user", {});
          
          const done = el(`<div class="container">
            <div class="card" style="text-align:center">
              ${createCharacterAvatar(isPerfect ? "ğŸ‰" : "ğŸ‘", isPerfect ? "Ù…Ø«Ø§Ù„ÙŠ! Ø£Ù†Øª Ø±Ø§Ø¦Ø¹!" : "Ø£Ø­Ø³Ù†Øª! Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªØ­Ø³Ù†")}
              <div style="height:12px"></div>
              <h2 class="h2">ğŸŠ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
              <div class="countdown" style="font-size:64px;margin:20px 0">${score}</div>
              <p class="p">Ù†Ù‚Ø·Ø©</p>
              
              <div style="background:#fff4df;padding:16px;border-radius:12px;margin:16px 0;text-align:right">
                <div style="margin-bottom:8px">âœ… Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©: <b>${correctAnswers}/${qs.length}</b></div>
                <div style="margin-bottom:8px">ğŸ”¥ Ø£Ù‚ØµÙ‰ Ø³Ù„Ø³Ù„Ø©: <b>${maxCombo}</b></div>
                <div style="margin-bottom:8px">â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <b>${u.level}</b></div>
                <div>ğŸ’ Ø§Ù„Ø®Ø¨Ø±Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: <b>${u.xp} XP</b></div>
              </div>

              ${isPerfect ? `<div class="achievement" style="margin:10px 0">ğŸ’¯ Ù†ØªÙŠØ¬Ø© Ù…Ø«Ø§Ù„ÙŠØ©!</div>` : ''}
              
              <div class="row" style="gap:8px">
                <button class="btn" onclick="go('/stages')" style="flex:1">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
                <button class="btn secondary" onclick="go('/home')" style="flex:1">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
              </div>
            </div>
          </div>`);
          $("#app").replaceChildren(done);
          return;
        }

        const choices = q.choices.map((c, i) => `<button class="choice" data-i="${i}">${c}</button>`).join("");
        const difficultyColor = q.difficulty === 'easy' ? '#21a179' : q.difficulty === 'medium' ? '#f29f05' : '#c0392b';
        
        const view = layout(`
          <div class="row" style="justify-content:space-between;margin-bottom:10px">
            <div>
              <div class="badge">Ø³Ø¤Ø§Ù„ ${index + 1}/${qs.length}</div>
              ${combo > 1 ? `<span class="streak-badge">ğŸ”¥ ${combo}</span>` : ''}
            </div>
            <div class="timer" style="font-size:18px">â± ${timeLeft}s</div>
          </div>
          
          <div style="background:#fff4df;padding:8px 12px;border-radius:8px;margin-bottom:10px;text-align:center">
            <span style="color:${difficultyColor};font-weight:600">âš¡ ${q.difficulty === 'easy' ? 'Ø³Ù‡Ù„' : q.difficulty === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'ØµØ¹Ø¨'}</span>
            <span style="margin:0 10px">â€¢</span>
            <span style="font-weight:600">Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}</span>
          </div>

          ${createCharacterAvatar(q.signImage || "ğŸ¤”", "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¬ÙŠØ¯Ø§Ù‹!")}
          <h2 class="h2" style="margin:16px 0">${q.text}</h2>
          <div class="grid">${choices}</div>
          <div class="row" style="margin-top:10px;gap:8px">
            ${q.hint ? `<button id="hintBtn" class="btn secondary" style="flex:1">ğŸ’¡ ØªÙ„Ù…ÙŠØ­</button>` : ''}
            <button id="skipBtn" class="btn secondary" style="flex:1">â­ ØªØ®Ø·ÙŠ</button>
          </div>
          ${q.hint ? `<div id="hintBox" class="hint" style="display:none;margin-top:8px">ğŸ’¡ ${q.hint}</div>` : ''}
        `, "quiz");

        $("#app").replaceChildren(view);

        $("#hintBtn")?.addEventListener("click", () => {
          const box = $("#hintBox");
          if (box) box.style.display = box.style.display === "none" ? "block" : "none";
        });

        $("#skipBtn").addEventListener("click", () => {
          combo = 0;
          nextQ();
        });

        // attach handlers to all choice buttons (fix: use $$ not $)
        $$(".choice").forEach(btn => {
          btn.addEventListener("click", (e) => {
            if (locked) return;
            locked = true;
            const i = Number(e.currentTarget.getAttribute("data-i"));
            const correct = i === q.correctIndex;
            
            if (correct) {
              const points = q.difficulty === 'easy' ? 10 : q.difficulty === 'medium' ? 15 : 20;
              const timeBonus = Math.floor(timeLeft / 2);
              const comboBonus = combo * 2;
              const totalPoints = points + timeBonus + comboBonus;
              
              score += totalPoints;
              correctAnswers++;
              combo++;
              if (combo > maxCombo) maxCombo = combo;
              
              e.currentTarget.classList.add("correct");
              
              if (totalPoints > points) {
                const bonus = el(`<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--ok);color:white;padding:10px 20px;border-radius:12px;font-weight:700;animation:slideUp 0.5s ease">+${totalPoints} ğŸ‰</div>`);
                e.currentTarget.style.position = 'relative';
                e.currentTarget.appendChild(bonus);
              }
            } else {
              combo = 0;
              e.currentTarget.classList.add("wrong");
            }
            
            setTimeout(() => nextQ(), 1200);
          });
        });

        clearInterval(timerId);
        timeLeft = timePerQ;
        timerId = setInterval(() => {
          timeLeft--;
          const t = $(".timer");
          if (t) {
            t.textContent = `â± ${timeLeft}s`;
            if (timeLeft <= 5) t.style.color = '#c0392b';
          }
          if (timeLeft <= 0) {
            clearInterval(timerId);
            combo = 0;
            nextQ();
          }
        }, 1000);
      }

      function nextQ() {
        index++;
        locked = false;
        renderQ();
      }
      renderQ();
    };

    /** Enhanced Simulation **/
    routes["/simulation"] = () => {
      const u = MemoryDB.get("user", {});
      let selectedSign = null;
      let currentQuestion = null;
      
      const simulationQuestions = [
        { sign: "ğŸ‘‹", options: ["Ø§Ù„Ø³Ù„Ø§Ù…", "ÙˆØ¯Ø§Ø¹Ø§Ù‹", "Ù…Ø±Ø­Ø¨Ø§Ù‹"], correct: "Ù…Ø±Ø­Ø¨Ø§Ù‹" },
        { sign: "ğŸ‘", options: ["Ù†Ø¹Ù…", "Ù„Ø§", "Ø±Ø¨Ù…Ø§"], correct: "Ù†Ø¹Ù…" },
        { sign: "â¤ï¸", options: ["Ø­Ø¨", "ØµØ¯Ø§Ù‚Ø©", "Ø¹Ø§Ø¦Ù„Ø©"], correct: "Ø­Ø¨" },
        { sign: "ğŸ™", options: ["Ø´ÙƒØ±Ø§Ù‹", "Ù…Ù† ÙØ¶Ù„Ùƒ", "Ø¢Ø³Ù"], correct: "Ø´ÙƒØ±Ø§Ù‹" },
      ];
      
      currentQuestion = simulationQuestions[Math.floor(Math.random() * simulationQuestions.length)];
      
      const content = `
        <h2 class="h2">ğŸ­ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h2>
        <p class="p">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„ØµØ­ÙŠØ­</p>
        
        ${createCharacterAvatar(currentQuestion.sign, "Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©ØŸ")}
        
        <h3 style="text-align:center;margin:20px 0">Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©ØŸ</h3>
        
        <div id="options">
          ${currentQuestion.options.map(opt => `
            <div class="simulation-option" data-option="${opt}">
              <h3 style="margin:0">${opt}</h3>
            </div>
          `).join('')}
        </div>
        
        <button id="checkBtn" class="btn" disabled style="margin-top:16px">âœ“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="btn secondary" onclick="location.reload()" style="margin-top:8px">ğŸ”„ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
      `;
      
      const view = layout(content, "simulation");
      $("#app").replaceChildren(view);
      
      // simulation options: use $$ to get NodeList
      $$(".simulation-option").forEach(opt => {
        opt.addEventListener("click", (e) => {
          $$(".simulation-option").forEach(o => o.classList.remove("selected"));
          e.currentTarget.classList.add("selected");
          selectedSign = e.currentTarget.getAttribute("data-option");
          $("#checkBtn").disabled = false;
        });
      });
      
      $("#checkBtn").addEventListener("click", () => {
        if (selectedSign === currentQuestion.correct) {
          showModal("ØµØ­ÙŠØ­! ğŸ‰", "Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ØªØ§Ø²Ø©! +10 XP");
          gainXP(10);
          setTimeout(() => location.reload(), 2000);
        } else {
          showModal("Ø®Ø·Ø£ ğŸ˜…", "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!");
        }
      });
    };

    /** Enhanced Multiplayer **/
    routes["/multiplayer"] = () => {
      const u = MemoryDB.get("user", {});
      const rooms = MemoryDB.get("rooms", [
        { id: "room1", name: "ØºØ±ÙØ© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†", players: 3, maxPlayers: 4, difficulty: "Ø³Ù‡Ù„" },
        { id: "room2", name: "ØºØ±ÙØ© Ø§Ù„Ù…Ø­ØªØ±ÙÙŠÙ†", players: 2, maxPlayers: 4, difficulty: "ØµØ¹Ø¨" },
        { id: "room3", name: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø³Ø±Ø¹Ø©", players: 1, maxPlayers: 2, difficulty: "Ù…ØªÙˆØ³Ø·" },
      ]);
      
      const leaderboard = MemoryDB.get("leaderboard", [
        { name: "Ø£Ø­Ù…Ø¯", score: 850, level: 8 },
        { name: u.name, score: u.totalScore || 0, level: u.level },
        { name: "ÙØ§Ø·Ù…Ø©", score: 720, level: 7 },
        { name: "Ù…Ø­Ù…Ø¯", score: 650, level: 6 },
        { name: "Ø³Ø§Ø±Ø©", score: 580, level: 5 },
      ]).sort((a, b) => b.score - a.score);
      
      const content = `
        <h2 class="h2">âš”ï¸ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</h2>
        
        <h3 style="font-size:16px;margin:16px 0 8px">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
        <div style="background:#fff;border-radius:12px;padding:12px;margin-bottom:16px;max-height:200px;overflow:auto">
          ${leaderboard.slice(0, 5).map((player, i) => `
            <div class="leaderboard-item ${player.name === u.name ? 'style="background:#fff4df"' : ''}">
              <div style="display:flex;align-items:center;gap:12px">
                <span class="rank">#${i + 1}</span>
                <div class="player-avatar">${player.name[0]}</div>
                <div>
                  <div style="font-weight:600">${player.name}</div>
                  <div class="small">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${player.level}</div>
                </div>
              </div>
              <div style="font-weight:700;color:var(--primary)">${player.score}</div>
            </div>
          `).join('')}
        </div>
        
        <h3 style="font-size:16px;margin:16px 0 8px">ğŸšª Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
        ${rooms.map(room => `
          <div class="multiplayer-room" onclick="joinRoom('${room.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="margin:0;font-size:16px">${room.name}</h3>
              <span class="badge">${room.difficulty}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="small">ğŸ‘¥ ${room.players}/${room.maxPlayers} Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>
              <span style="color:var(--primary);font-weight:600">Ø§Ù†Ø¶Ù… â†</span>
            </div>
          </div>
        `).join('')}
        
        <button class="btn" onclick="createRoom()" style="margin-top:12px">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
      `;
      
      $("#app").replaceChildren(layout(content, "multiplayer"));
    };

    window.joinRoom = function(roomId) {
      showModal("Ù‚Ø±ÙŠØ¨Ø§Ù‹!", "ğŸ® Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹!");
    };

    window.createRoom = function() {
      showModal("Ù‚Ø±ÙŠØ¨Ø§Ù‹!", "ğŸ® Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±Ù Ù‚Ø±ÙŠØ¨Ø§Ù‹!");
    };

    /** Enhanced Community **/
    routes["/community"] = () => {
      const user = MemoryDB.get("user", {});
      const key = "chat:global";
      const messages = MemoryDB.get(key, [
        { uid: "bot", name: "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", text: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ø¬ØªÙ…Ø¹ Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©! ğŸ‘‹", at: Date.now() - 60000 },
        { uid: "u2", name: "Ø£Ø­Ù…Ø¯", text: "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…! ÙƒÙŠÙ Ø£Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù…ØŸ", at: Date.now() - 50000 },
        { uid: "bot", name: "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", text: "Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØªØ¯Ø±Ø¨ ÙŠÙˆÙ…ÙŠØ§Ù‹! ğŸ“š", at: Date.now() - 40000 },
      ]);

      const view = layout(`
        <h2 class="h2">ğŸ’¬ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h2>
        <p class="p">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ØªØ¹Ù„Ù…ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ† ÙˆØ´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ</p>
        
        <div class="chat" id="chat"></div>
        
        <div class="row" style="margin-top:12px">
          <input id="msg" class="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex:1" />
          <button id="sendBtn" class="btn row">ğŸ“¤</button>
        </div>
        
        <div style="text-align:center;margin-top:12px">
          <span class="small">ğŸ’¬ ${user.messagesSent || 0} Ø±Ø³Ø§Ù„Ø© Ø£Ø±Ø³Ù„ØªÙ‡Ø§</span>
        </div>
      `, "community");
      
      $("#app").replaceChildren(view);

      function renderMsgs() {
        const box = $("#chat");
        box.innerHTML = "";
        messages.forEach(m => {
          const time = new Date(m.at);
          const timeStr = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
          const item = el(`<div class="msg ${m.uid === user.uid ? "me" : ""}">
            <div class="small">${m.name} â€¢ ${timeStr}</div>
            <div style="margin-top:4px">${m.text}</div>
          </div>`);
          box.appendChild(item);
        });
        box.scrollTop = box.scrollHeight;
      }
      renderMsgs();

      function sendMsg() {
        const input = $("#msg");
        const text = input.value.trim();
        if (!text) return;
        
        messages.push({
          uid: user.uid,
          name: user.name || "Ù„Ø§Ø¹Ø¨",
          text,
          at: Date.now(),
        });
        
        user.messagesSent = (user.messagesSent || 0) + 1;
        MemoryDB.set("user", user);
        MemoryDB.set(key, messages);
        input.value = "";
        renderMsgs();

        // Auto responses
        const responses = [
          "Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… ğŸŒŸ",
          "Ù†ØµÙŠØ­Ø© Ù…Ù…ØªØ§Ø²Ø©! Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ğŸ‘",
          "Ù‡Ø°Ø§ Ù…Ù„Ù‡Ù… Ø¬Ø¯Ø§Ù‹! ğŸ’ª",
          "Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…ÙÙŠØ¯Ø©! ğŸ“š",
        ];
        
        setTimeout(() => {
          messages.push({
            uid: "bot",
            name: "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯",
            text: responses[Math.floor(Math.random() * responses.length)],
            at: Date.now(),
          });
          MemoryDB.set(key, messages);
          renderMsgs();
        }, 2000);
      }

      $("#sendBtn").addEventListener("click", sendMsg);
      $("#msg").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMsg();
      });
    };

    /** Enhanced Profile **/
    routes["/profile"] = () => {
      const u = MemoryDB.get("user", {});
      const nextLevelXP = u.level * 50;
      const progress = ((u.xp % 50) / 50) * 100;
      
      const unlockedAchievements = u.achievements.map(id => 
        achievements.find(a => a.id === id)
      );
      
      const content = `
        <h2 class="h2">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        
        <div style="text-align:center;margin:20px 0">
          <div class="player-avatar" style="width:80px;height:80px;font-size:32px;margin:0 auto 12px">
            ${u.name[0]}
          </div>
          <h2 style="margin:8px 0">${u.name}</h2>
          <div class="badge">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${u.level}</div>
        </div>
        
        <div style="background:#fff4df;padding:12px;border-radius:12px;margin:16px 0">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <span class="small">Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${u.level + 1}</span>
            <span class="small">${u.xp} / ${nextLevelXP} XP</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%"></div>
          </div>
        </div>
        
        <div class="grid">
          <div class="stat-card">
            <div class="stat-value">${u.totalScore || 0}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.gamesPlayed || 0}</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.bestScore || 0}</div>
            <div class="stat-label">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${u.perfectGames || 0}</div>
            <div class="stat-label">Ù†ØªØ§Ø¦Ø¬ Ù…Ø«Ø§Ù„ÙŠØ©</div>
          </div>
        </div>
        
        <h3 style="font-size:16px;margin:20px 0 8px">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (${unlockedAchievements.length}/${achievements.length})</h3>
        <div style="background:#fff;border-radius:12px;padding:16px;text-align:center">
          ${unlockedAchievements.length > 0 ? 
            unlockedAchievements.map(ach => `<span class="achievement">${ach.icon} ${ach.name}</span>`).join('') :
            '<p class="p">Ù„Ù… ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¥Ù†Ø¬Ø§Ø² Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨!</p>'
          }
        </div>
        
        <h3 style="font-size:16px;margin:20px 0 8px">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div style="background:#fff;border-radius:12px;padding:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px">
            <span>Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ÙØªÙˆØ­Ø©</span>
            <b>${u.unlockedStages.length}/3</b>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px">
            <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</span>
            <b>${u.messagesSent || 0}</b>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</span>
            <b>${u.gamesPlayed > 0 ? Math.round((u.perfectGames / u.gamesPlayed) * 100) : 0}%</b>
          </div>
        </div>
        
        <button class="btn secondary" onclick="if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) { location.reload(); }" style="margin-top:16px">
          ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
      `;
      
      $("#app").replaceChildren(layout(content, "profile"));
    };

    function render() {
      const path = location.hash.split('?')[0].replace("#", "") || "/";
      if (routes[path]) routes[path]();
      else go("/");
    }

    // Initialize
    initProfile();
    startRouter();
  </script>
</body>
</html>